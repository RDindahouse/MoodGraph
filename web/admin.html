<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Admin – Mood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
</head>

<body class="admin-page">
  <div class="container">
    <!-- top bar with navigation and global theme toggle -->
    <div class="top-bar">
      <h1 data-i18n="adminPanelTitle">Admin Panel</h1>
      <div class="top-bar-right">
        <a href="/" class="theme-toggle" data-i18n="adminHome">Home</a>
        <div class="auth-user" id="admin-auth-status"></div>
        <div class="language-selector">
          <select id="language-select" title="Language">
            <option value="en">English</option>
            <option value="ru">Русский</option>
          </select>
        </div>
        <button id="theme-toggle" class="theme-toggle" type="button">
          <img id="theme-icon" src="/icons/dark_theme.svg" width="20" height="20" />
        </button>
      </div>
    </div>

    <div class="card mb-16">
      <div class="mt-8 small">
        <span data-i18n="currentAdminLabel">Current admin:</span>
        <span id="admin-username">Loading...</span><br />
        <span data-i18n="telegramStatusLabel">Telegram status:</span>
        <span id="admin-tg-status">Loading...</span>
      </div>
    </div>

    <div class="grid mt-16">
      <div class="card">
        <h2 data-i18n="botSiteSettings">Bot and Site Settings</h2>

        <div class="field">
          <label for="bot-token" data-i18n="botTokenLabel">Telegram Bot Token</label>
          <input id="bot-token" type="text" placeholder="123456:ABC-DEF..." />
        </div>

        <div class="field">
          <label for="site-base-url" data-i18n="siteAddressLabel">Site Address (for invites)</label>
          <input id="site-base-url" type="text" placeholder="https://example.com" />
          <div class="small" data-i18n="siteAddressHint">
            Used to form full invite link. If left empty, window.location.origin will be used.
          </div>
        </div>

        <button class="btn primary mb-16" id="btn-save-bot-token" data-i18n="saveSettings">
          Save Settings
        </button>

        <div class="status" id="status-bot" data-i18n="loading">Loading...</div>

        <div class="field mt-16">
          <h3 class="mb-12" data-i18n="botLanguageTitle">Bot Language (personal)</h3>
          <label for="admin-language" data-i18n="botLanguageLabel">Language for your bot messages:</label>
          <select id="admin-language"></select>
        </div>
        <button class="btn primary" id="btn-save-admin-language" data-i18n="saveLanguage">
          Save Language
        </button>
        <div class="status mt-8" id="status-admin-language"></div>
      </div>

      <div class="card">
        <h2 data-i18n="telegramLinking">Telegram Linking</h2>
        <button class="btn primary mt-8" id="btn-generate-link-token" data-i18n="generateLinkToken">
          Generate Link Token
        </button>
        <div class="status" id="status-link" data-i18n="linkStatusHint">
          Click button to get link token.
        </div>
      </div>
    </div>

    <div class="grid mt-16">
      <div class="card">
        <h2 data-i18n="changePasswordTitle">Change Admin Password</h2>

        <div class="field">
          <label for="pwd-old" data-i18n="currentPasswordLabel">Current Password</label>
          <input id="pwd-old" type="password" placeholder="Old password" />
        </div>

        <div class="field">
          <label for="pwd-new" data-i18n="newPasswordLabel">New Password</label>
          <input id="pwd-new" type="password" placeholder="New password" />
        </div>

        <div class="field">
          <label for="pwd-new2" data-i18n="repeatPasswordLabel">Repeat New Password</label>
          <input id="pwd-new2" type="password" placeholder="Repeat new" />
        </div>

        <button class="btn primary" id="btn-change-password" data-i18n="changePasswordBtn">
          Change Password
        </button>

        <div class="status mt-8" id="status-password" data-i18n="passwordStatusHint">
          Enter current and new password.
        </div>
      </div>
    </div>

    <div class="grid mt-16">
      <div class="card">
        <h2 data-i18n="myChartsTitle">My Charts</h2>

        <div class="field">
          <label for="board-title" data-i18n="newChartTitleLabel">New Chart Title</label>
          <input id="board-title" type="text" placeholder="E.g.: Daily mood" data-i18n="newChartTitlePlaceholder" />
        </div>

        <div class="field">
          <label>
            <input type="checkbox" id="board-public" />
            <span class="small" data-i18n="publicChartLabel">Public chart (visible to all on site)</span>
          </label>
        </div>

        <button class="btn primary" id="btn-create-board" data-i18n="createChartBtn">Create Chart</button>

        <div class="status mt-8" id="boards-status" data-i18n="loading">Loading...</div>
        <div class="mt-8" id="boards-list"></div>
      </div>

      <div class="card">
        <h2 data-i18n="invitesTitle">Invites</h2>

        <div class="field">
          <label for="invite-board" data-i18n="inviteBoardLabel">Chart to give access to</label>
          <select id="invite-board"></select>
        </div>

        <div class="field">
          <label for="invite-role" data-i18n="inviteRoleLabel">Who to invite</label>
          <select id="invite-role">
            <option value="user" data-i18n="inviteRoleUser">Regular user</option>
            <option value="admin" data-i18n="inviteRoleAdmin">Administrator</option>
          </select>
        </div>

        <button class="btn primary" id="btn-create-invite" data-i18n="createInviteBtn">Create Invite</button>

        <div class="status mt-8" id="invite-output" data-i18n="inviteStatusHint">
          Select chart and role first.
        </div>
        <div class="small mt-8" data-i18n="inviteOneTimeNote">
          Invite is one-time: after registration via token it becomes invalid.
        </div>
      </div>
    </div>

    <div class="card mt-16">
      <h2 data-i18n="usersAccessTitle">Users and Chart Access</h2>
      <div class="small" data-i18n="usersAccessHint">
        Here you can view which users have access to which charts, and enable/disable access.
      </div>
      <div class="mt-8" id="users-access-output" data-i18n="loading">Loading...</div>
    </div>
  </div>

  <!-- shared scripts -->
  <script src="/i18n.js"></script>
  <script src="/theme.js"></script>

  <script>
    let siteBaseUrl = "";
    let currentAdminId = null;
    let currentAdminUsername = "";
    let currentAdminTelegramId = null;

    const languageLabel = (code) => {
      if (typeof getLanguageLabel === "function") {
        return getLanguageLabel(code);
      }
      const dict =
        (typeof translations !== "undefined" && translations[code]) || {};
      return dict.languageName || String(code || "").toUpperCase();
    };

    const availableLanguages = () => {
      if (typeof getAvailableLanguages === "function") {
        return getAvailableLanguages();
      }
      if (typeof translations !== "undefined") {
        return Object.keys(translations);
      }
      return [];
    };

    function populateLanguageSelect(selectEl) {
      if (!selectEl) return;
      selectEl.innerHTML = "";
      availableLanguages().forEach((lang) => {
        const opt = document.createElement("option");
        opt.value = lang;
        opt.textContent = languageLabel(lang);
        selectEl.appendChild(opt);
      });
    }

    function ensureLanguageOption(selectEl, lang) {
      if (!selectEl || !lang) return;
      const exists = Array.from(selectEl.options || []).some(
        (opt) => opt.value === lang
      );
      if (!exists) {
        const opt = document.createElement("option");
        opt.value = lang;
        opt.textContent = languageLabel(lang);
        selectEl.appendChild(opt);
      }
    }

    function boardOwnedByCurrent(b) {
      if (!b) return false;
      // match by username
      if (
        currentAdminUsername &&
        (b.ownerAdminUsername === currentAdminUsername ||
          b.owner_admin_username === currentAdminUsername ||
          b.ownerUsername === currentAdminUsername ||
          b.owner_username === currentAdminUsername)
      ) {
        return true;
      }
      // match by telegram id
      if (
        currentAdminTelegramId &&
        (String(b.ownerTelegramId || "") === String(currentAdminTelegramId) ||
          String(b.owner_telegram_id || "") === String(currentAdminTelegramId))
      ) {
        return true;
      }
      // fallback: allow legacy boards without owner info
      return (
        !b.ownerAdminUsername &&
        !b.owner_admin_username &&
        !b.ownerTelegramId &&
        !b.owner_telegram_id
      );
    }

    async function apiJson(url, method = "GET", body) {
      const opts = { method, headers: {} };
      if (body) {
        opts.headers["Content-Type"] = "application/json";
        opts.body = JSON.stringify(body);
      }
      const res = await fetch(url, opts);
      if (!res.ok) {
        let msg = res.status + " " + res.statusText;
        try {
          const j = await res.json();
          if (j.error) msg = j.error;
        } catch { }
        throw new Error(msg);
      }
      return res.json();
    }
    async function loadAdminInfo() {
      const nameEl = document.getElementById("admin-username");
      const tgEl = document.getElementById("admin-tg-status");
      const authStatus = document.getElementById("admin-auth-status");
      const langSelect = document.getElementById("admin-language");
      nameEl.textContent = "Loading…";
      tgEl.textContent = "Loading…";

      try {
        const data = await apiJson("/api/admin/me");
        const admin = data.admin;
        if (!admin) {
          nameEl.textContent = t("unknown");
          tgEl.textContent = t("unknown");
          if (authStatus) authStatus.style.display = "none";
          return;
        }

        nameEl.textContent = admin.username || "(no name)";
        currentAdminId = admin.id || admin._id || null;
        currentAdminUsername = admin.username || "";
        currentAdminTelegramId = admin.telegramId || null;

        // Load admin language
        if (langSelect && admin.language) {
          ensureLanguageOption(langSelect, admin.language);
          langSelect.value = admin.language;
        }

        if (authStatus) {
          authStatus.style.display = "block";
          authStatus.innerHTML =
            t("signedInAs") +
            ' <b>' +
            (admin.username || "(no name)") +
            '</b><button type="button" id="admin-logout-btn">' +
            t("logout") +
            "</button>";
          const logoutBtn = document.getElementById("admin-logout-btn");
          if (logoutBtn) {
            logoutBtn.onclick = async () => {
              try {
                await fetch("/api/logout", { method: "POST" });
                window.location.reload();
              } catch (e) {
                console.error("Logout error:", e);
              }
            };
          }
        }

        if (admin.telegramId) {
          tgEl.innerHTML =
            '<span class="pill green">' +
            t("linked") +
            "</span> " +
            (admin.telegramUsername
              ? "(@" + admin.telegramUsername + ", id " + admin.telegramId + ")"
              : "(id " + admin.telegramId + ")");
        } else {
          tgEl.innerHTML =
            '<span class="pill gray">' +
            t("notLinked") +
            "</span> " +
            t("linkInstruction");
        }
      } catch (e) {
        console.error(e);
        nameEl.textContent = t("statusErrorPrefix");
        tgEl.textContent = t("statusErrorPrefix") + " " + e.message;
        if (authStatus) authStatus.style.display = "none";
      }
    }

    async function loadBotConfig() {
      const status = document.getElementById("status-bot");
      const tokenInput = document.getElementById("bot-token");
      const siteInput = document.getElementById("site-base-url");

      status.textContent = t("loadingGeneric");
      try {
        const cfg = await apiJson("/api/admin/config");
        if (cfg.botToken) {
          tokenInput.value = "";
          status.textContent = t("boardCreated");
          status.style.color = "lightgreen";
        } else {
          status.textContent = t("boardsEmpty");
          status.style.color = "#9ca3af";
        }

        siteBaseUrl = cfg.siteBaseUrl || "";
        siteInput.value = siteBaseUrl;

        if (!siteBaseUrl) {
          siteBaseUrl = window.location.origin;
        }
      } catch (e) {
        status.textContent = t("statusErrorPrefix") + " " + e.message;
        status.style.color = "red";
      }
    }

    async function saveBotToken() {
      const tokenInput = document.getElementById("bot-token");
      const siteInput = document.getElementById("site-base-url");
      const status = document.getElementById("status-bot");

      const token = tokenInput.value.trim();
      const site = siteInput.value.trim();

      status.textContent = t("saving");
      status.style.color = "#9ca3af";

      try {
        await apiJson("/api/admin/config", "POST", {
          botToken: token || undefined,
          siteBaseUrl: site || "",
        });
        status.textContent = t("saveSettings");
        status.style.color = "lightgreen";

        if (site) {
          siteBaseUrl = site;
        } else {
          siteBaseUrl = window.location.origin;
        }

        tokenInput.value = "";
      } catch (e) {
        status.textContent = t("statusErrorPrefix") + " " + e.message;
        status.style.color = "red";
      }
    }

    async function generateLinkToken() {
      const status = document.getElementById("status-link");
      status.textContent = t("generatingToken");
      status.style.color = "#9ca3af";
      try {
        const data = await apiJson("/api/admin/link-token", "POST", {});
        // show token with copy button
        status.innerHTML =
          t("tokenLabel") + ' <code id="link-token">' + data.token + "</code>" +
          "<br>" + t("fullCommandLabel") + ' <code id="link-full">/link ' + data.token + "</code>" +
          '<br><button class="btn primary" id="btn-copy-link">' + t("copy") + "</button>";

        status.style.color = "lightgreen";

        // attach copy handler
        const copyBtn = document.getElementById("btn-copy-link");
        const tokenEl = document.getElementById("link-token");
        if (copyBtn && tokenEl) {
          copyBtn.addEventListener("click", async () => {
            try {
              const fullCmd = document.getElementById("link-full").textContent;
              await navigator.clipboard.writeText(fullCmd);
              copyBtn.textContent = t("copied");
              setTimeout(() => (copyBtn.textContent = t("copy")), 1500);
            } catch (e) {
              // fallback: select text
              const range = document.createRange();
              range.selectNodeContents(tokenEl);
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
            }
          });
        }
      } catch (e) {
        status.textContent = "Ошибка: " + e.message;
        status.style.color = "red";
      }
    }

    let cachedBoards = [];

    async function loadBoards() {
      const status = document.getElementById("boards-status");
      const list = document.getElementById("boards-list");
      const inviteSelect = document.getElementById("invite-board");

      status.textContent = "Загрузка графиков...";
      list.innerHTML = "";
      inviteSelect.innerHTML = "";

      try {
        const data = await apiJson("/api/admin/boards");
        const boards = (data.boards || []).filter(boardOwnedByCurrent);
        cachedBoards = boards;

        if (!boards.length) {
          status.textContent = "Графиков пока нет.";
          status.style.color = "#9ca3af";
          return;
        }

        status.textContent = "";
        status.style.color = "#9ca3af";

        const ul = document.createElement("ul");
        ul.style.listStyle = "none";
        ul.style.padding = "0";
        ul.style.margin = "0";

        boards.forEach((b) => {
          const li = document.createElement("li");
          li.style.display = "flex";
          li.style.alignItems = "center";
          li.style.justifyContent = "space-between";
          li.style.padding = "4px 0";

          const left = document.createElement("div");
          left.innerHTML =
            "<b>" +
            b.title +
            "</b> <span class='small'>(id: " +
            b.id +
            ")</span><br>" +
            "<span class='small'>Владелец: " +
            (b.ownerAdminUsername || "—") +
            (b.ownerTelegramId ? ", tgId " + b.ownerTelegramId : "") +
            "</span> " +
            (b.isPublic
              ? "<span class='pill green'>public</span>"
              : "<span class='pill gray'>private</span>");

          const btnDel = document.createElement("button");
          btnDel.className = "btn danger";
          btnDel.textContent = "Удалить";
          btnDel.addEventListener("click", async () => {
            if (!confirm("Удалить график '" + b.title + "'?")) return;
            try {
              await apiJson(
                "/api/admin/boards/" + encodeURIComponent(b.id),
                "DELETE"
              );
              await loadBoards();
              await loadUsersAccess();
            } catch (e) {
              alert("Ошибка удаления: " + e.message);
            }
          });

          li.appendChild(left);
          li.appendChild(btnDel);
          ul.appendChild(li);
        });

        list.appendChild(ul);

        boards.forEach((b) => {
          const opt = document.createElement("option");
          opt.value = b.id;
          opt.textContent = b.title + " (" + b.id + ")";
          inviteSelect.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
        status.textContent = "Ошибка: " + e.message;
        status.style.color = "red";
      }
    }

    async function createBoard() {
      const titleInput = document.getElementById("board-title");
      const publicCheckbox = document.getElementById("board-public");
      const status = document.getElementById("boards-status");

      const title = titleInput.value.trim();
      if (!title) {
        status.textContent = "Введите название графика.";
        status.style.color = "orange";
        return;
      }

      status.textContent = "Создание...";
      status.style.color = "#9ca3af";

      try {
        await apiJson("/api/admin/boards", "POST", {
          title,
          isPublic: publicCheckbox.checked,
        });
        titleInput.value = "";
        publicCheckbox.checked = false;
        status.textContent = "График создан.";
        status.style.color = "lightgreen";
        await loadBoards();
        await loadUsersAccess();
      } catch (e) {
        status.textContent = "Ошибка: " + e.message;
        status.style.color = "red";
      }
    }

    async function createInvite() {
      const boardSelect = document.getElementById("invite-board");
      const roleSelect = document.getElementById("invite-role");
      const out = document.getElementById("invite-output");

      const boardId = boardSelect.value;
      const role = roleSelect.value;

      if (!boardId) {
        out.textContent = "Сначала создай график.";
        out.style.color = "orange";
        return;
      }

      out.textContent = "Создание инвайта...";
      out.style.color = "#9ca3af";

      try {
        const data = await apiJson("/api/admin/invites", "POST", {
          boardId,
          role,
        });

        const base =
          (siteBaseUrl && siteBaseUrl.trim()) || window.location.origin;
        const fullUrl =
          base.replace(/\/$/, "") + (data.inviteUrl || "/invite/" + data.token);

        out.innerHTML =
          "Инвайт создан.<br>" +
          "Токен: <code>" +
          data.token +
          "</code><br>" +
          "Полная ссылка: <a href=\"" +
          fullUrl +
          '" target="_blank">' +
          fullUrl +
          "</a><br>" +
          "Роль: " +
          (role === "admin" ? "администратор" : "пользователь") +
          "<br>Токен одноразовый: после регистрации станет недействительным.";
        out.style.color = "lightgreen";
      } catch (e) {
        out.textContent = "Ошибка: " + e.message;
        out.style.color = "red";
      }
    }

    async function loadUsersAccess() {
      const out = document.getElementById("users-access-output");
      out.textContent = "Loading...";
      try {
        const data = await apiJson("/api/admin/users");
        const users = data.users || [];
        const boards = data.boards || [];

        const ownBoards = boards.filter(boardOwnedByCurrent);

        if (!users.length) {
          out.textContent = "No users yet.";
          return;
        }

        if (!ownBoards.length) {
          out.textContent = "No boards available to manage.";
          return;
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");

        headRow.innerHTML =
          "<th>User</th><th>Role</th>" +
          ownBoards.map((b) => `<th>${b.title}</th>`).join("");
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        users.forEach((u) => {
          const tr = document.createElement("tr");

          const nameTd = document.createElement("td");
          nameTd.textContent = u.username;
          tr.appendChild(nameTd);

          const roleTd = document.createElement("td");
          roleTd.textContent =
            (u.role || "user") === "admin" ? "admin" : "user";
          tr.appendChild(roleTd);

          ownBoards.forEach((b) => {
            const td = document.createElement("td");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = u.boards.includes(b.id);

            checkbox.addEventListener("change", async () => {
              try {
                const newBoards = new Set(u.boards || []);
                if (checkbox.checked) {
                  newBoards.add(b.id);
                } else {
                  newBoards.delete(b.id);
                }
                const arrBoards = Array.from(newBoards);
                u.boards = arrBoards;

                await apiJson(
                  "/api/admin/users/" + encodeURIComponent(u.id) + "/boards",
                  "POST",
                  { boards: arrBoards }
                );
              } catch (err) {
                alert("?????? ????????? ???????: " + err.message);
              }
            });

            td.appendChild(checkbox);
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        out.innerHTML = "";
        out.appendChild(table);
      } catch (e) {
        out.textContent = "Error: " + e.message;
      }
    }

    async function saveAdminLanguage() {
      const langSelect = document.getElementById("admin-language");
      const status = document.getElementById("status-admin-language");
      const language = langSelect.value;

      status.textContent = "Saving…";
      status.style.color = "var(--text)";

      try {
        await apiJson("/api/admin/language", "POST", { language });
        status.textContent = "Language saved ✓";
        status.style.color = "lightgreen";
      } catch (e) {
        status.textContent = "Error: " + e.message;
        status.style.color = "red";
      }
    }

    async function changeAdminPassword() {
      const oldInput = document.getElementById("pwd-old");
      const newInput = document.getElementById("pwd-new");
      const new2Input = document.getElementById("pwd-new2");
      const status = document.getElementById("status-password");

      const oldPassword = (oldInput.value || "").trim();
      const newPassword = (newInput.value || "").trim();
      const newPassword2 = (new2Input.value || "").trim();

      status.style.color = "#9ca3af";

      if (!oldPassword || !newPassword || !newPassword2) {
        status.textContent = "Заполните все поля.";
        status.style.color = "orange";
        return;
      }

      if (newPassword !== newPassword2) {
        status.textContent = "Новый пароль и подтверждение не совпадают.";
        status.style.color = "orange";
        return;
      }

      if (newPassword.length < 6) {
        status.textContent = "Новый пароль должен быть длиной хотя бы 6 символов.";
        status.style.color = "orange";
        return;
      }

      status.textContent = "Смена пароля...";
      try {
        await apiJson("/api/admin/password", "POST", {
          oldPassword,
          newPassword,
        });
        status.textContent = "Пароль успешно изменён.";
        status.style.color = "lightgreen";

        oldInput.value = "";
        newInput.value = "";
        new2Input.value = "";
      } catch (e) {
        status.textContent = "Ошибка: " + e.message;
        status.style.color = "red";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initTheme();
      if (typeof updateAllTranslations === "function") {
        updateAllTranslations();
      }

      const uiLangSelect = document.getElementById("language-select");
      const adminLangSelect = document.getElementById("admin-language");
      populateLanguageSelect(adminLangSelect);

      if (uiLangSelect) {
        uiLangSelect.value =
          (typeof getCurrentLanguage === "function" && getCurrentLanguage()) ||
          (typeof currentLanguage !== "undefined" ? currentLanguage : "en");
        uiLangSelect.addEventListener("change", (e) => {
          setLanguage(e.target.value);
          updateAllTranslations();
        });
        window.addEventListener("storage", (event) => {
          if (event.key === "language" && event.newValue && uiLangSelect) {
            uiLangSelect.value = event.newValue;
            updateAllTranslations();
          }
        });
      }

      document
        .getElementById("btn-save-bot-token")
        .addEventListener("click", saveBotToken);
      document
        .getElementById("btn-save-admin-language")
        .addEventListener("click", saveAdminLanguage);
      document
        .getElementById("btn-generate-link-token")
        .addEventListener("click", generateLinkToken);
      document
        .getElementById("btn-create-board")
        .addEventListener("click", createBoard);
      document
        .getElementById("btn-create-invite")
        .addEventListener("click", createInvite);

      const pwdBtn = document.getElementById("btn-change-password");
      if (pwdBtn) {
        pwdBtn.addEventListener("click", changeAdminPassword);
      }

      (async () => {
        await loadAdminInfo();
        await loadBotConfig();
        await loadBoards();
        await loadUsersAccess();
      })();
    });
  </script>
</body>

</html>
