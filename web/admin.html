<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Admin – Mood</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css" />
  <style>
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      display: flex;
      justify-content: center;
      padding: 30px 10px;
      margin: 0;
    }

    .container {
      max-width: 1100px;
      width: 100%;
    }

    h1 {
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 26px;
    }

    .top-bar {
      margin-bottom: 24px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.8);
      border: 1px solid var(--border-subtle);
    }

    .card h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="password"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      color: var(--text);
      font-size: 14px;
      box-sizing: border-box;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .field {
      margin-bottom: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 6px 12px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      background: #1f2937;
      color: var(--text);
      transition: background 0.15s ease, transform 0.1s ease;
    }

    .btn.primary {
      background: var(--accent);
      color: #fff;
    }

    .btn.danger {
      background: #b91c1c;
      color: #fff;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      background: #4b5563;
    }

    .btn.primary:hover:not(:disabled) {
      background: #2563eb;
    }

    .btn.danger:hover:not(:disabled) {
      background: #dc2626;
    }

    .status {
      font-size: 13px;
      margin-top: 6px;
      color: #9ca3af;
      word-break: break-all;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: var(--card-bg);
      padding: 2px 4px;
      border-radius: 4px;
      border: 1px solid var(--border-subtle);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th,
    td {
      border-bottom: 1px solid var(--border-subtle);
      padding: 4px 6px;
      text-align: left;
    }

    th {
      font-weight: 500;
      color: #9ca3af;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .small {
      font-size: 12px;
      color: #9ca3af;
    }

    .mt-8 {
      margin-top: 8px;
    }

    .mt-12 {
      margin-top: 12px;
    }

    .inline {
      display: inline-block;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      background: #111827;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid #1f2937;
    }

    .pill.green {
      border-color: #16a34a;
      color: #bbf7d0;
    }

    .pill.red {
      border-color: #b91c1c;
      color: #fecaca;
    }

    .pill.gray {
      border-color: #4b5563;
      color: #e5e7eb;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- top bar with navigation and global theme toggle -->
    <div class="top-bar">
      <h1>Admin Panel</h1>
      <div class="top-bar-right">
        <a href="/" class="theme-toggle">Home</a>
        <div class="auth-user" id="admin-auth-status" style="display:none; margin: 0 12px;"></div>
        <button id="theme-toggle" class="theme-toggle" type="button">
          <img id="theme-icon" src="/icons/sun-light.svg" width="20" height="20" />
        </button>
      </div>
    </div>

    <div class="card" style="margin-bottom:16px;">
      <div class="small">
        Login: basic-auth. Default admin: <code>admin / admin</code>.
      </div>
      <div class="mt-8 small">
        Current admin: <span id="admin-username">Loading…</span><br />
        Telegram status: <span id="admin-tg-status">Loading…</span>
      </div>

      <div class="mt-16">
        <h3 style="margin-bottom: 12px;">Bot Language (personal)</h3>
        <div class="field">
          <label for="admin-language">Language for your bot messages:</label>
          <select id="admin-language">
            <option value="en">English</option>
            <option value="ru">Russian</option>
          </select>
        </div>
        <button class="btn primary" id="btn-save-admin-language">
          Save Language
        </button>
        <div class="status" id="status-admin-language" style="margin-top: 8px;"></div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h2>Bot and Site Settings</h2>

        <div class="field">
          <label for="bot-token">Telegram Bot Token</label>
          <input id="bot-token" type="text" placeholder="123456:ABC-DEF..." />
        </div>

        <div class="field">
          <label for="site-base-url">Site Address (for invites)</label>
          <input id="site-base-url" type="text" placeholder="https://example.com" />
          <div class="small">
            Used to form full invite link.
            If left empty, <code>window.location.origin</code> will be used.
          </div>
        </div>

        <div class="field">
          <label for="bot-language">Bot Language</label>
          <select id="bot-language">
            <option value="en">English</option>
            <option value="ru">Russian</option>
          </select>
          <div class="small">Changes bot messages globally.</div>
        </div>

        <button class="btn primary" id="btn-save-bot-token">
          Save Settings
        </button>

        <div class="status" id="status-bot">Loading...</div>
        <div class="small mt-8">
          After changing bot token, restart the bot:
          <code>node bot.js</code>
        </div>
      </div>

      <div class="card">
        <h2>Telegram Linking</h2>
        <button class="btn primary mt-8" id="btn-generate-link-token">
          Generate Link Token
        </button>
        <div class="status" id="status-link">
          Click button to get link token.
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h2>Change Admin Password</h2>

        <div class="field">
          <label for="pwd-old">Current Password</label>
          <input id="pwd-old" type="password" placeholder="Old password" />
        </div>

        <div class="field">
          <label for="pwd-new">New Password</label>
          <input id="pwd-new" type="password" placeholder="New password" />
        </div>

        <div class="field">
          <label for="pwd-new2">Repeat New Password</label>
          <input id="pwd-new2" type="password" placeholder="Repeat new" />
        </div>

        <button class="btn primary" id="btn-change-password">
          Change Password
        </button>

        <div class="status mt-8" id="status-password">
          Enter current and new password.
        </div>
      </div>
    </div>

    <div class="grid" style="margin-top:16px;">
      <div class="card">
        <h2>My Charts</h2>

        <div class="field">
          <label for="board-title">New Chart Title</label>
          <input id="board-title" type="text" placeholder="E.g.: Daily mood" />
        </div>

        <div class="field">
          <label>
            <input type="checkbox" id="board-public" />
            <span class="small">Public chart (visible to all on site)</span>
          </label>
        </div>

        <button class="btn primary" id="btn-create-board">Create Chart</button>

        <div class="status mt-8" id="boards-status">Loading...</div>
        <div class="mt-8" id="boards-list"></div>
      </div>

      <div class="card">
        <h2>Invites</h2>

        <div class="field">
          <label for="invite-board">Chart to give access to</label>
          <select id="invite-board"></select>
        </div>

        <div class="field">
          <label for="invite-role">Who to invite</label>
          <select id="invite-role">
            <option value="user">Regular user</option>
            <option value="admin">Administrator</option>
          </select>
        </div>

        <button class="btn primary" id="btn-create-invite">Create Invite</button>

        <div class="status mt-8" id="invite-output">
          Select chart and role first.
        </div>
        <div class="small mt-8">
          Invite is one-time: after registration via token it becomes
          invalid.
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <h2>Users and Chart Access</h2>
      <div class="small">
        Here you can view which users have access to which charts,
        and enable/disable access.
      </div>
      <div class="mt-8" id="users-access-output">Loading...</div>
    </div>
  </div>

  <!-- shared theme script -->
  <script src="/theme.js"></script>

  <script>
    let siteBaseUrl = "";

    async function apiJson(url, method = "GET", body) {
      const opts = { method, headers: {} };
      if (body) {
        opts.headers["Content-Type"] = "application/json";
        opts.body = JSON.stringify(body);
      }
      const res = await fetch(url, opts);
      if (!res.ok) {
        let msg = res.status + " " + res.statusText;
        try {
          const j = await res.json();
          if (j.error) msg = j.error;
        } catch { }
        throw new Error(msg);
      }
      return res.json();
    }
    async function loadAdminInfo() {
      const nameEl = document.getElementById("admin-username");
      const tgEl = document.getElementById("admin-tg-status");
      const authStatus = document.getElementById("admin-auth-status");
      const langSelect = document.getElementById("admin-language");
      nameEl.textContent = "Loading…";
      tgEl.textContent = "Loading…";

      try {
        const data = await apiJson("/api/admin/me");
        const admin = data.admin;
        if (!admin) {
          nameEl.textContent = "unknown";
          tgEl.textContent = "no data";
          if (authStatus) authStatus.style.display = "none";
          return;
        }

        nameEl.textContent = admin.username || "(no name)";

        // Load admin language
        if (langSelect && admin.language) {
          langSelect.value = admin.language;
        }

        if (authStatus) {
          authStatus.style.display = "block";
          authStatus.innerHTML = 'Signed in as <b>' + (admin.username || "(no name)") + '</b><button type="button" id="admin-logout-btn">Sign out</button>';
          const logoutBtn = document.getElementById("admin-logout-btn");
          if (logoutBtn) {
            logoutBtn.onclick = async () => {
              try {
                await fetch("/api/logout", { method: "POST" });
                window.location.reload();
              } catch (e) {
                console.error("Logout error:", e);
              }
            };
          }
        }

        if (admin.telegramId) {
          tgEl.innerHTML =
            '<span class="pill green">Linked</span> ' +
            (admin.telegramUsername
              ? "(@" + admin.telegramUsername + ", id " + admin.telegramId + ")"
              : "(id " + admin.telegramId + ")");
        } else {
          tgEl.innerHTML =
            '<span class="pill gray">Not linked</span> ' +
            "Generate token and send it to bot via /link.";
        }
      } catch (e) {
        console.error(e);
        nameEl.textContent = "Error";
        tgEl.textContent = "Error: " + e.message;
        if (authStatus) authStatus.style.display = "none";
      }
    }

    async function loadBotConfig() {
      const status = document.getElementById("status-bot");
      const tokenInput = document.getElementById("bot-token");
      const siteInput = document.getElementById("site-base-url");
      const langInput = document.getElementById("bot-language");

      status.textContent = "Loading...";
      try {
        const cfg = await apiJson("/api/admin/config");
        if (cfg.botToken) {
          tokenInput.value = "";
          status.textContent = "Bot token is set.";
          status.style.color = "lightgreen";
        } else {
          status.textContent = "Bot token not set yet.";
          status.style.color = "#9ca3af";
        }

        siteBaseUrl = cfg.siteBaseUrl || "";
        siteInput.value = siteBaseUrl;

        const botLang = cfg.botLanguage || "en";
        langInput.value = botLang;

        if (!siteBaseUrl) {
          siteBaseUrl = window.location.origin;
        }
      } catch (e) {
        status.textContent = "Error: " + e.message;
        status.style.color = "red";
      }
    }

    async function saveBotToken() {
      const tokenInput = document.getElementById("bot-token");
      const siteInput = document.getElementById("site-base-url");
      const langInput = document.getElementById("bot-language");
      const status = document.getElementById("status-bot");

      const token = tokenInput.value.trim();
      const site = siteInput.value.trim();
      const lang = langInput.value.trim();

      status.textContent = "Saving...";
      status.style.color = "#9ca3af";

      try {
        await apiJson("/api/admin/config", "POST", {
          botToken: token || undefined,
          siteBaseUrl: site || "",
          botLanguage: lang || "en",
        });
        status.textContent = "Settings saved.";
        status.style.color = "lightgreen";

        if (site) {
          siteBaseUrl = site;
        } else {
          siteBaseUrl = window.location.origin;
        }

        tokenInput.value = "";
      } catch (e) {
        status.textContent = "Error: " + e.message;
        status.style.color = "red";
      }
    }

    async function generateLinkToken() {
      const status = document.getElementById("status-link");
      status.textContent = "Запрос токена...";
      status.style.color = "#9ca3af";
      try {
        const data = await apiJson("/api/admin/link-token", "POST", {});
        // show token with copy button
        status.innerHTML =
          "Токен привязки: <code id=\"link-token\">" + data.token + "</code>" +
          "<br>Отправь боту: <code id=\"link-full\">/link " + data.token + "</code>" +
          "<br><button class=\"btn\" id=\"btn-copy-link\">Copy</button>";

        status.style.color = "lightgreen";

        // attach copy handler
        const copyBtn = document.getElementById("btn-copy-link");
        const tokenEl = document.getElementById("link-token");
        if (copyBtn && tokenEl) {
          copyBtn.addEventListener("click", async () => {
            try {
              const fullCmd = document.getElementById("link-full").textContent;
              await navigator.clipboard.writeText(fullCmd);
              copyBtn.textContent = "Copied";
              setTimeout(() => (copyBtn.textContent = "Copy"), 1500);
            } catch (e) {
              // fallback: select text
              const range = document.createRange();
              range.selectNodeContents(tokenEl);
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
            }
          });
        }
      } catch (e) {
        status.textContent = "Ошибка: " + e.message;
        status.style.color = "red";
      }
    }

    let cachedBoards = [];

    async function loadBoards() {
      const status = document.getElementById("boards-status");
      const list = document.getElementById("boards-list");
      const inviteSelect = document.getElementById("invite-board");

      status.textContent = "Загрузка графиков...";
      list.innerHTML = "";
      inviteSelect.innerHTML = "";

      try {
        const data = await apiJson("/api/admin/boards");
        const boards = data.boards || [];
        cachedBoards = boards;

        if (!boards.length) {
          status.textContent = "Графиков пока нет.";
          status.style.color = "#9ca3af";
          return;
        }

        status.textContent = "";
        status.style.color = "#9ca3af";

        const ul = document.createElement("ul");
        ul.style.listStyle = "none";
        ul.style.padding = "0";
        ul.style.margin = "0";

        boards.forEach((b) => {
          const li = document.createElement("li");
          li.style.display = "flex";
          li.style.alignItems = "center";
          li.style.justifyContent = "space-between";
          li.style.padding = "4px 0";

          const left = document.createElement("div");
          left.innerHTML =
            "<b>" +
            b.title +
            "</b> <span class='small'>(id: " +
            b.id +
            ")</span><br>" +
            "<span class='small'>Владелец: " +
            (b.ownerAdminUsername || "—") +
            (b.ownerTelegramId ? ", tgId " + b.ownerTelegramId : "") +
            "</span> " +
            (b.isPublic
              ? "<span class='pill green'>public</span>"
              : "<span class='pill gray'>private</span>");

          const btnDel = document.createElement("button");
          btnDel.className = "btn danger";
          btnDel.textContent = "Удалить";
          btnDel.addEventListener("click", async () => {
            if (!confirm("Удалить график '" + b.title + "'?")) return;
            try {
              await apiJson(
                "/api/admin/boards/" + encodeURIComponent(b.id),
                "DELETE"
              );
              await loadBoards();
              await loadUsersAccess();
            } catch (e) {
              alert("Ошибка удаления: " + e.message);
            }
          });

          li.appendChild(left);
          li.appendChild(btnDel);
          ul.appendChild(li);
        });

        list.appendChild(ul);

        boards.forEach((b) => {
          const opt = document.createElement("option");
          opt.value = b.id;
          opt.textContent = b.title + " (" + b.id + ")";
          inviteSelect.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
        status.textContent = "Ошибка: " + e.message;
        status.style.color = "red";
      }
    }

    async function createBoard() {
      const titleInput = document.getElementById("board-title");
      const publicCheckbox = document.getElementById("board-public");
      const status = document.getElementById("boards-status");

      const title = titleInput.value.trim();
      if (!title) {
        status.textContent = "Введите название графика.";
        status.style.color = "orange";
        return;
      }

      status.textContent = "Создание...";
      status.style.color = "#9ca3af";

      try {
        await apiJson("/api/admin/boards", "POST", {
          title,
          isPublic: publicCheckbox.checked,
        });
        titleInput.value = "";
        publicCheckbox.checked = false;
        status.textContent = "График создан.";
        status.style.color = "lightgreen";
        await loadBoards();
        await loadUsersAccess();
      } catch (e) {
        status.textContent = "Ошибка: " + e.message;
        status.style.color = "red";
      }
    }

    async function createInvite() {
      const boardSelect = document.getElementById("invite-board");
      const roleSelect = document.getElementById("invite-role");
      const out = document.getElementById("invite-output");

      const boardId = boardSelect.value;
      const role = roleSelect.value;

      if (!boardId) {
        out.textContent = "Сначала создай график.";
        out.style.color = "orange";
        return;
      }

      out.textContent = "Создание инвайта...";
      out.style.color = "#9ca3af";

      try {
        const data = await apiJson("/api/admin/invites", "POST", {
          boardId,
          role,
        });

        const base =
          (siteBaseUrl && siteBaseUrl.trim()) || window.location.origin;
        const fullUrl =
          base.replace(/\/$/, "") + (data.inviteUrl || "/invite/" + data.token);

        out.innerHTML =
          "Инвайт создан.<br>" +
          "Токен: <code>" +
          data.token +
          "</code><br>" +
          "Полная ссылка: <a href=\"" +
          fullUrl +
          '" target="_blank">' +
          fullUrl +
          "</a><br>" +
          "Роль: " +
          (role === "admin" ? "администратор" : "пользователь") +
          "<br>Токен одноразовый: после регистрации станет недействительным.";
        out.style.color = "lightgreen";
      } catch (e) {
        out.textContent = "Ошибка: " + e.message;
        out.style.color = "red";
      }
    }

    async function loadUsersAccess() {
      const out = document.getElementById("users-access-output");
      out.textContent = "Загрузка...";
      try {
        const data = await apiJson("/api/admin/users");
        const users = data.users || [];
        const boards = data.boards || [];

        if (!users.length) {
          out.textContent = "Пока нет пользователей.";
          return;
        }

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");

        headRow.innerHTML =
          "<th>Пользователь</th><th>Роль</th>" +
          boards.map((b) => `<th>${b.title}</th>`).join("");
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        users.forEach((u) => {
          const tr = document.createElement("tr");

          const nameTd = document.createElement("td");
          nameTd.textContent = u.username;
          tr.appendChild(nameTd);

          const roleTd = document.createElement("td");
          roleTd.textContent =
            (u.role || "user") === "admin" ? "admin" : "user";
          tr.appendChild(roleTd);

          boards.forEach((b) => {
            const td = document.createElement("td");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = u.boards.includes(b.id);

            checkbox.addEventListener("change", async () => {
              try {
                const newBoards = new Set(u.boards || []);
                if (checkbox.checked) {
                  newBoards.add(b.id);
                } else {
                  newBoards.delete(b.id);
                }
                const arrBoards = Array.from(newBoards);
                u.boards = arrBoards;

                await apiJson(
                  "/api/admin/users/" + encodeURIComponent(u.id) + "/boards",
                  "POST",
                  { boards: arrBoards }
                );
              } catch (err) {
                alert("Ошибка обновления: " + err.message);
              }
            });

            td.appendChild(checkbox);
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        out.innerHTML = "";
        out.appendChild(table);
      } catch (e) {
        out.textContent = "Ошибка: " + e.message;
      }
    }

    async function saveAdminLanguage() {
      const langSelect = document.getElementById("admin-language");
      const status = document.getElementById("status-admin-language");
      const language = langSelect.value;

      status.textContent = "Saving…";
      status.style.color = "var(--text)";

      try {
        await apiJson("/api/admin/language", "POST", { language });
        status.textContent = "Language saved ✓";
        status.style.color = "lightgreen";
      } catch (e) {
        status.textContent = "Error: " + e.message;
        status.style.color = "red";
      }
    }

    async function changeAdminPassword() {
      const oldInput = document.getElementById("pwd-old");
      const newInput = document.getElementById("pwd-new");
      const new2Input = document.getElementById("pwd-new2");
      const status = document.getElementById("status-password");

      const oldPassword = (oldInput.value || "").trim();
      const newPassword = (newInput.value || "").trim();
      const newPassword2 = (new2Input.value || "").trim();

      status.style.color = "#9ca3af";

      if (!oldPassword || !newPassword || !newPassword2) {
        status.textContent = "Заполните все поля.";
        status.style.color = "orange";
        return;
      }

      if (newPassword !== newPassword2) {
        status.textContent = "Новый пароль и подтверждение не совпадают.";
        status.style.color = "orange";
        return;
      }

      if (newPassword.length < 6) {
        status.textContent = "Новый пароль должен быть длиной хотя бы 6 символов.";
        status.style.color = "orange";
        return;
      }

      status.textContent = "Смена пароля...";
      try {
        await apiJson("/api/admin/password", "POST", {
          oldPassword,
          newPassword,
        });
        status.textContent = "Пароль успешно изменён.";
        status.style.color = "lightgreen";

        oldInput.value = "";
        newInput.value = "";
        new2Input.value = "";
      } catch (e) {
        status.textContent = "Ошибка: " + e.message;
        status.style.color = "red";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      initTheme();
      document
        .getElementById("btn-save-bot-token")
        .addEventListener("click", saveBotToken);
      document
        .getElementById("btn-save-admin-language")
        .addEventListener("click", saveAdminLanguage);
      document
        .getElementById("btn-generate-link-token")
        .addEventListener("click", generateLinkToken);
      document
        .getElementById("btn-create-board")
        .addEventListener("click", createBoard);
      document
        .getElementById("btn-create-invite")
        .addEventListener("click", createInvite);

      const pwdBtn = document.getElementById("btn-change-password");
      if (pwdBtn) {
        pwdBtn.addEventListener("click", changeAdminPassword);
      }

      loadAdminInfo();
      loadBotConfig();
      loadBoards();
      loadUsersAccess();
    });
  </script>
</body>

</html>